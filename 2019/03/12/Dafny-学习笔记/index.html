<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">























  
  
  
  

  

  

  

  

  

  






<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Dafny 学习笔记GuideIntroductionDafny use annotations to write programs with no bugs. The annotation below means all elements in a are positive: 1forall k: int :: 0 &amp;lt;= k &amp;lt; a.Length ==&amp;gt; 0 &amp;lt; a[k]">
<meta name="keywords" content="形式化验证">
<meta property="og:type" content="article">
<meta property="og:title" content="Dafny 学习笔记">
<meta property="og:url" content="http://DimLight1998.github.io/2019/03/12/Dafny-学习笔记/index.html">
<meta property="og:site_name" content="Computation &amp; Design">
<meta property="og:description" content="Dafny 学习笔记GuideIntroductionDafny use annotations to write programs with no bugs. The annotation below means all elements in a are positive: 1forall k: int :: 0 &amp;lt;= k &amp;lt; a.Length ==&amp;gt; 0 &amp;lt; a[k]">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-03-13T03:36:49.703Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Dafny 学习笔记">
<meta name="twitter:description" content="Dafny 学习笔记GuideIntroductionDafny use annotations to write programs with no bugs. The annotation below means all elements in a are positive: 1forall k: int :: 0 &amp;lt;= k &amp;lt; a.Length ==&amp;gt; 0 &amp;lt; a[k]">






  <link rel="canonical" href="http://DimLight1998.github.io/2019/03/12/Dafny-学习笔记/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Dafny 学习笔记 | Computation & Design</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Computation & Design</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://DimLight1998.github.io/2019/03/12/Dafny-学习笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang Yang">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Computation & Design">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Dafny 学习笔记

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-12 14:45:23" itemprop="dateCreated datePublished" datetime="2019-03-12T14:45:23+08:00">2019-03-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-13 11:36:49" itemprop="dateModified" datetime="2019-03-13T11:36:49+08:00">2019-03-13</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Dafny-学习笔记"><a href="#Dafny-学习笔记" class="headerlink" title="Dafny 学习笔记"></a>Dafny 学习笔记</h1><h2 id="Guide"><a href="#Guide" class="headerlink" title="Guide"></a>Guide</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>Dafny use annotations to write programs with no bugs. The annotation below means all elements in <code>a</code> are positive:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">forall k: int :: 0 &lt;= k &lt; a.Length ==&gt; 0 &lt; a[k]</span><br></pre></td></tr></table></figure>
<p>Now you turn the task of <strong><em>writing bug-free programs</em></strong> into <strong><em>writing bug-free annotations</em></strong>.</p>
<h3 id="Methods"><a href="#Methods" class="headerlink" title="Methods"></a>Methods</h3><p>Use <code>method</code> to declare a method. Methods are different from functions in Dafny. <strong>Syntax example:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">method MultipleReturns(x: int, y: int) returns (more: int, less: int)</span><br><span class="line">&#123;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>A method can return multiple values, and each value has a name. They can be assigned inside the method body. Use <code>return</code> with no argument to return early from the method. <strong>Parameters are read-only.</strong></p>
<hr>
<ul>
<li>Use <code>:=</code> for variable assignments.</li>
<li>Braces are required in <code>if</code> <strong>statements</strong> even if the branch has only one statement. Otherwise it will be an <strong>expression</strong>.</li>
</ul>
<a id="more"></a>
<h3 id="Pre-and-Postconditions"><a href="#Pre-and-Postconditions" class="headerlink" title="Pre- and Postconditions"></a>Pre- and Postconditions</h3><h4 id="Simple-Usage"><a href="#Simple-Usage" class="headerlink" title="Simple Usage"></a>Simple Usage</h4><p>Use <code>requires</code> for preconditions and <code>ensures</code> for postconditions. Preconditions must be held before calling the method, and postconditions will be held after the method returns from any points. <strong>Syntax example:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">method MultipleReturns(x: int, y: int) returns (more: int, less: int)</span><br><span class="line">   requires 0 &lt; y</span><br><span class="line">   ensures less &lt; x &lt; more</span><br><span class="line">&#123;</span><br><span class="line">   more := x + y;</span><br><span class="line">   less := x - y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>One method can have multiple preconditions and/or postconditions.</p>
<h4 id="With-Conditions"><a href="#With-Conditions" class="headerlink" title="With Conditions"></a>With Conditions</h4><p>pre- and postconditions can have conditions with implication operator <code>==&gt;</code>, for example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">method Abs(x: int) returns (y: int)</span><br><span class="line">   ensures 0 &lt;= y</span><br><span class="line">   ensures 0 &lt;= x ==&gt; x == y</span><br><span class="line">   ensures x &lt; 0 ==&gt; y == -x</span><br><span class="line">&#123;</span><br><span class="line">   // body as before</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Dafny won&#39;t see the method body except for the current one when making proofs, it only uses method annotations. However the behavior is described both in the postconditions and the method body, <strong><em>that&#39;s why Dafny has functions</em></strong>.</p>
<hr>
<ul>
<li>Dafny supports chain operator syntax: <code>less &lt; x &lt; more</code>.</li>
</ul>
<h3 id="Assertions"><a href="#Assertions" class="headerlink" title="Assertions"></a>Assertions</h3><p>Use <code>assert</code> to make assertions in the method body. <strong>Syntax example:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">method Testing()</span><br><span class="line">&#123;</span><br><span class="line">   var v := Abs(3);</span><br><span class="line">   assert 0 &lt;= v;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li>Use <code>var</code> with optional type declaration to declare local variables: <code>var v := 3;</code> or <code>var v: int := 3;</code>. Types will be inferred when omitted.</li>
</ul>
<h3 id="Functions"><a href="#Functions" class="headerlink" title="Functions"></a>Functions</h3><h4 id="What-are-Functions"><a href="#What-are-Functions" class="headerlink" title="What are Functions"></a>What are Functions</h4><p>Use <code>function</code> to define a function. The syntax is almost the same as method definition, except for the keyword.</p>
<p><strong>Function must contain only one expression</strong>, for example, the <code>fib</code> function below uses an <code>if</code> expression:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function fib(n: nat): nat</span><br><span class="line">&#123;</span><br><span class="line">   if n == 0 then 0 else</span><br><span class="line">   if n == 1 then 1 else</span><br><span class="line">                  fib(n - 1) + fib(n - 2)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>When Dafny make proofs, functions will be expanded, so you can write <code>assert 2 == fib(3)</code> directly without annotations in <code>fib</code>. However, <strong>functions can not be called from methods</strong>, they are only used for verification.</p>
<blockquote>
<p><code>nat</code> is a type for natural numbers.</p>
</blockquote>
<h4 id="Function-Method"><a href="#Function-Method" class="headerlink" title="Function Method"></a>Function Method</h4><p>Use <code>function method</code> to declare a function method. A function method is a function, and it can be called from methods.</p>
<h3 id="Loop-Invariants"><a href="#Loop-Invariants" class="headerlink" title="Loop Invariants"></a>Loop Invariants</h3><p>Use <code>invariant</code> to declare loop invariants in <code>while</code> loops. <strong>Syntax example:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">method ComputeFib(n: nat) returns (b: nat)</span><br><span class="line">   ensures b == fib(n)</span><br><span class="line">&#123;</span><br><span class="line">   if n == 0 &#123; return 0; &#125;</span><br><span class="line">   var i: int := 1;</span><br><span class="line">   var a := 0;</span><br><span class="line">       b := 1;</span><br><span class="line">   while i &lt; n</span><br><span class="line">      invariant 0 &lt; i &lt;= n</span><br><span class="line">      invariant a == fib(i - 1)</span><br><span class="line">      invariant b == fib(i)</span><br><span class="line">   &#123;</span><br><span class="line">      a, b := b, a + b;</span><br><span class="line">      i := i + 1;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Loop invariants must be held <strong>before</strong> and <strong>after</strong> the loop body. Therefore, before the first execution and after the last execution of the loop body, those invariants are held.</p>
<p><strong><em>Loop invariants are necessary because Dafny doesn&#39;t know how many times a loop will be executed.</em></strong></p>
<hr>
<ul>
<li>Dafny has parallel assignments: <code>a, b = b, a</code>.</li>
</ul>
<h3 id="Termination"><a href="#Termination" class="headerlink" title="Termination"></a>Termination</h3><p>There are circumstances where we want Dafny to proof the program will terminate: <strong>loops</strong> and <strong>recursive calls</strong>. In both cases, use <code>decreases</code> to annotate an expression will get lower and is bounded by zero after each execution. <strong>Syntax example for loops:</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">while 0 &lt; i</span><br><span class="line">   invariant 0 &lt;= i</span><br><span class="line">   decreases i</span><br><span class="line">&#123;</span><br><span class="line">   i := i - 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Quantifiers"><a href="#Quantifiers" class="headerlink" title="Quantifiers"></a>Quantifiers</h3><p>Use <code>forall</code> to make conditions on a set. The set can be infinite:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assert forall k :: k &lt; k + 1;</span><br></pre></td></tr></table></figure>
<p>But typically finite. <code>forall</code> usually appears in <code>requires</code>, <code>ensures</code> and <code>assert</code>s. A full example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">method Find(a: array&lt;int&gt;, key: int) returns (index: int)</span><br><span class="line">   ensures 0 &lt;= index ==&gt; index &lt; a.Length &amp;&amp; a[index] == key</span><br><span class="line">   ensures index &lt; 0 ==&gt; forall k :: 0 &lt;= k &lt; a.Length ==&gt; a[k] != key</span><br><span class="line">&#123;</span><br><span class="line">   index := 0;</span><br><span class="line">   while index &lt; a.Length</span><br><span class="line">      invariant 0 &lt;= index &lt;= a.Length</span><br><span class="line">      invariant forall k :: 0 &lt;= k &lt; index ==&gt; a[k] != key</span><br><span class="line">   &#123;</span><br><span class="line">      if a[index] == key &#123; return; &#125;</span><br><span class="line">      index := index + 1;</span><br><span class="line">   &#125;</span><br><span class="line">   index := -1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Predicates"><a href="#Predicates" class="headerlink" title="Predicates"></a>Predicates</h3><p>Predicates are only syntactical sugar for functions returning booleans. Use <code>predicate</code> to define them. <strong>Syntax example (indication only):</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">predicate sorted(a: array&lt;int&gt;)</span><br><span class="line">   requires a != null</span><br><span class="line">&#123;</span><br><span class="line">   forall j, k :: 0 &lt;= j &lt; k &lt; a.Length ==&gt; a[j] &lt;= a[k]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>There is no return type because the type is always a boolean. <strong><em>Recall that functions can not be called, so the <code>forall</code> statement is also inside a condition.</em></strong></p>
<h3 id="Framing"><a href="#Framing" class="headerlink" title="Framing"></a>Framing</h3><p>For some reasons, if a function needs to access some data on the <strong>heap</strong> (e.g. arrays), a <code>read</code> annotation is required:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">predicate sorted(a: array&lt;int&gt;)</span><br><span class="line">   requires a != null</span><br><span class="line">   read a</span><br><span class="line">&#123;</span><br><span class="line">   forall j, k :: 0 &lt;= j &lt; k &lt; a.Length ==&gt; a[j] &lt;= a[k]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And a <code>modifies</code> annotation is required for modify data.</p>
<h3 id="Binary-Search"><a href="#Binary-Search" class="headerlink" title="Binary Search"></a>Binary Search</h3><p>Combining all we have learned, we have a <code>BinarySearch</code> method:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">predicate sorted(a: array&lt;int&gt;)</span><br><span class="line">   requires a != null</span><br><span class="line">   reads a</span><br><span class="line">&#123;</span><br><span class="line">   forall j, k :: 0 &lt;= j &lt; k &lt; a.Length ==&gt; a[j] &lt;= a[k]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">method BinarySearch(a: array&lt;int&gt;, value: int) returns (index: int)</span><br><span class="line">   requires a != null &amp;&amp; 0 &lt;= a.Length &amp;&amp; sorted(a)</span><br><span class="line">   ensures 0 &lt;= index ==&gt; index &lt; a.Length &amp;&amp; a[index] == value</span><br><span class="line">   ensures index &lt; 0 ==&gt; forall k :: 0 &lt;= k &lt; a.Length ==&gt; a[k] != value</span><br><span class="line">&#123;</span><br><span class="line">   var low, high := 0, a.Length;</span><br><span class="line">   while low &lt; high</span><br><span class="line">      invariant 0 &lt;= low &lt;= high &lt;= a.Length</span><br><span class="line">      invariant forall i ::</span><br><span class="line">         0 &lt;= i &lt; a.Length &amp;&amp; !(low &lt;= i &lt; high) ==&gt; a[i] != value</span><br><span class="line">   &#123;</span><br><span class="line">      var mid := (low + high) / 2;</span><br><span class="line">      if a[mid] &lt; value</span><br><span class="line">      &#123;</span><br><span class="line">         low := mid + 1;</span><br><span class="line">      &#125;</span><br><span class="line">      else if value &lt; a[mid]</span><br><span class="line">      &#123;</span><br><span class="line">         high := mid;</span><br><span class="line">      &#125;</span><br><span class="line">      else</span><br><span class="line">      &#123;</span><br><span class="line">         return mid;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   return -1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><blockquote>
<p>Nothing to note for this section.</p>
</blockquote>
<h2 id="Termination-1"><a href="#Termination-1" class="headerlink" title="Termination"></a>Termination</h2><p>Use <code>decreases</code> to annotate a loop or recursive function/method will terminates. Sometimes Dafny will guess a termination annotation and these annotations can be omitted.</p>
<p><code>decreases</code> are often followed by an expression which evaluates to an integer, but they can also be followed by arrays (length in this case) or sets (subset relation in this case).</p>
<h3 id="Loop-Forever"><a href="#Loop-Forever" class="headerlink" title="Loop Forever"></a>Loop Forever</h3><p>If you want a loop to execute forever intentionally, use <code>decreases *</code>. The method containing the loop should also be annotated <code>decreases *</code>. Here is an example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">method hail(N: nat)</span><br><span class="line">   decreases *</span><br><span class="line">&#123;</span><br><span class="line">   var n := N;</span><br><span class="line">   while 1 &lt; n</span><br><span class="line">      decreases *</span><br><span class="line">   &#123; </span><br><span class="line">      n := if n % 2 == 0 then n / 2 else n * 3 + 1;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Multiple-Decreases-Expressions"><a href="#Multiple-Decreases-Expressions" class="headerlink" title="Multiple Decreases Expressions"></a>Multiple Decreases Expressions</h3><p>If multiple expressions are in the <code>decreases</code> annotation, they should decrease lexicographically. For example, for <code>decreases m, n</code>:</p>
<ul>
<li>If <code>m</code> decreases, then <code>n</code> can change whatever it likes.</li>
<li>If <code>m</code> doesn&#39;t change, then <code>n</code> should decrease.</li>
<li><code>m</code> shouldn&#39;t increase in any iteration.</li>
</ul>
<h3 id="Mutual-Recursive-Methods"><a href="#Mutual-Recursive-Methods" class="headerlink" title="Mutual Recursive Methods"></a>Mutual Recursive Methods</h3><p>Dafny can proof termination for mutual recursive methods too:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">predicate even(n: nat)</span><br><span class="line">   ensures even(n) &lt;==&gt; n % 2 == 0</span><br><span class="line">&#123;</span><br><span class="line">   if n == 0 then true else odd(n-1)</span><br><span class="line">&#125;</span><br><span class="line">predicate odd(n: nat)</span><br><span class="line">   ensures odd(n) &lt;==&gt; n % 2 != 0</span><br><span class="line">&#123;</span><br><span class="line">   if n == 0 then false else even(n-1)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Sets"><a href="#Sets" class="headerlink" title="Sets"></a>Sets</h2><p>Sets are orderless, <strong>immutable</strong> and can be used in annotations. <strong>Infinite sets are not allowed.</strong></p>
<h3 id="Sets-Operations"><a href="#Sets-Operations" class="headerlink" title="Sets Operations"></a>Sets Operations</h3><ul>
<li><code>+</code> for set union.</li>
<li><code>*</code> for set intersection.</li>
<li><code>-</code> for set difference.</li>
<li><code>&lt;=</code> for subset relation.</li>
<li><code>&lt;</code> for strict subset relation.</li>
<li><code>==</code> and <code>!=</code> for equality and inequality.</li>
<li><code>in</code> and <code>!in</code> for testing element membership.</li>
</ul>
<h3 id="Sets-Comprehension"><a href="#Sets-Comprehension" class="headerlink" title="Sets Comprehension"></a>Sets Comprehension</h3><p><strong>Syntax</strong>: <code>set x: T | p(x) :: f(x)</code>, where <code>T</code> is an optional type annotation, <code>p(x)</code> is a predicate, <code>f(x)</code> is a mapper function (identity if omitted). For example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assert (set x | x in &#123;0,1,2&#125; :: x + 1) == &#123;1,2,3&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Sequences"><a href="#Sequences" class="headerlink" title="Sequences"></a>Sequences</h2><p>Sequences are ordered, <strong>immutable</strong> and can be used in annotations.</p>
<h3 id="Sequences-Operations"><a href="#Sequences-Operations" class="headerlink" title="Sequences Operations"></a>Sequences Operations</h3><ul>
<li>Use <code>|s|</code> for sequences length.</li>
<li>Use <code>[s]</code> for sequences indexing.</li>
<li>Use <code>[a .. b]</code> for sequences slicing (<code>a</code> and <code>b</code> can be omitted).</li>
<li>Use <code>+</code> for sequences concatenation.</li>
<li>Use <code>in</code> and <code>!in</code> for testing element membership.</li>
</ul>
<h3 id="Sequences-Construction"><a href="#Sequences-Construction" class="headerlink" title="Sequences Construction"></a>Sequences Construction</h3><ul>
<li>Constructing from existing sequence with the element at position <code>i</code> modified to <code>v</code>: <code>s[i := v]</code>.</li>
<li>Constructing from existing array: <code>var s := a[..]</code>.</li>
</ul>
<h2 id="Collections"><a href="#Collections" class="headerlink" title="Collections"></a>Collections</h2><p>Data structures stored on the stack is called <strong>value types</strong>. They can not be modified.</p>
<p>Dafny has four value types: sets, sequences, multisets and maps.</p>
<h3 id="Multisets"><a href="#Multisets" class="headerlink" title="Multisets"></a>Multisets</h3><p>Multisets is like sets, except that it allows an element to occur multiple times.</p>
<p>Operations on multisets are almost the same as sets. Use <code>!!</code> for multisets disjoint (no common elements).</p>
<p>You can construct multisets by:</p>
<ul>
<li>Literally: <code>multiset{1, 2, 3, 4, 3, 2, 1}</code>.</li>
<li>From existing sets or sequences: <code>assert multiset({1, 1, 1, 2, 2}) == multiset{1, 2}</code>.</li>
</ul>
<h3 id="Maps"><a href="#Maps" class="headerlink" title="Maps"></a>Maps</h3><p>Maps are associative arrays.</p>
<h4 id="Maps-Operations"><a href="#Maps-Operations" class="headerlink" title="Maps Operations"></a>Maps Operations</h4><ul>
<li>Use <code>m[k]</code> for indexing.</li>
<li><p>Use <code>in</code> and <code>!in</code> to test <strong>key</strong> membership.</p>
</li>
<li><p>Use <code>!!</code> to test maps domain disjoint. A domain is the set of keys.</p>
</li>
</ul>
<h4 id="Maps-Constructions"><a href="#Maps-Constructions" class="headerlink" title="Maps Constructions"></a>Maps Constructions</h4><ul>
<li>Literally: <code>map[4 := 5, 5 := 6]</code>.</li>
<li>Modify from existing maps: <code>m[i := j]</code>.</li>
<li>Maps comprehension: <code>map i | i in m &amp;&amp; i != 3 :: m[i]</code>, which remove the key-value pair with key 3 from <code>m</code>.</li>
</ul>
<h2 id="Lemmas"><a href="#Lemmas" class="headerlink" title="Lemmas"></a>Lemmas</h2><p>Lemmas are used to provide intermediate steps for Dafny to make proofs. Dafny will prove the lemma, and use it to prove other things.</p>
<p>Lemmas are in fact methods. They can also be viewed as heavyweight assertions.</p>
<p>Use <code>lemma</code> for define a lemma. No modification is allowed in lemma body. Lemmas have preconditions and postconditions, and they also have parameters. Dafny will prove a lemma individually, and ensure that if the parameters meet preconditions, they will meet postconditions. After the lemma is proved, it can be called from other code to help Dafny make other proofs.</p>
<p>Check the example below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">lemma SkippingLemma(a : array&lt;int&gt;, j : int)</span><br><span class="line">   requires a != null</span><br><span class="line">   requires forall i :: 0 &lt;= i &lt; a.Length ==&gt; 0 &lt;= a[i]</span><br><span class="line">   requires forall i :: 0 &lt; i &lt; a.Length ==&gt; a[i-1]-1 &lt;= a[i]</span><br><span class="line">   requires 0 &lt;= j &lt; a.Length</span><br><span class="line">   ensures forall k :: j &lt;= k &lt; j + a[j] &amp;&amp; k &lt; a.Length ==&gt; a[k] != 0</span><br><span class="line">&#123;</span><br><span class="line">   var i := j;</span><br><span class="line">   while i &lt; j + a[j] &amp;&amp; i &lt; a.Length</span><br><span class="line">      invariant i &lt; a.Length ==&gt; a[j] - (i-j) &lt;= a[i]</span><br><span class="line">      invariant forall k :: j &lt;= k &lt; i &amp;&amp; k &lt; a.Length ==&gt; a[k] != 0</span><br><span class="line">   &#123;</span><br><span class="line">      i := i + 1;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">method FindZero(a: array&lt;int&gt;) returns (index: int)</span><br><span class="line">   requires a != null</span><br><span class="line">   requires forall i :: 0 &lt;= i &lt; a.Length ==&gt; 0 &lt;= a[i]</span><br><span class="line">   requires forall i :: 0 &lt; i &lt; a.Length ==&gt; a[i-1]-1 &lt;= a[i]</span><br><span class="line">   ensures index &lt; 0  ==&gt; forall i :: 0 &lt;= i &lt; a.Length ==&gt; a[i] != 0</span><br><span class="line">   ensures 0 &lt;= index ==&gt; index &lt; a.Length &amp;&amp; a[index] == 0</span><br><span class="line">&#123;</span><br><span class="line">   index := 0;</span><br><span class="line">   while index &lt; a.Length</span><br><span class="line">      invariant 0 &lt;= index</span><br><span class="line">      invariant forall k :: 0 &lt;= k &lt; index &amp;&amp; k &lt; a.Length ==&gt; a[k] != 0</span><br><span class="line">   &#123;</span><br><span class="line">      if a[index] == 0 &#123; return; &#125;</span><br><span class="line">      SkippingLemma(a, index);</span><br><span class="line">      index := index + a[index];</span><br><span class="line">   &#125;</span><br><span class="line">   index := -1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Modules"><a href="#Modules" class="headerlink" title="Modules"></a>Modules</h2><blockquote>
<p>Read the document when needed: <a href="https://rise4fun.com/Dafny/tutorial/Modules" target="_blank" rel="noopener">https://rise4fun.com/Dafny/tutorial/Modules</a>.</p>
</blockquote>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a href="https://rise4fun.com/Dafny/tutorial" target="_blank" rel="noopener">https://rise4fun.com/Dafny/tutorial</a></li>
</ul>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/形式化验证/" rel="tag"># 形式化验证</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/03/11/形式化验证课程笔记-3/" rel="next" title="形式化验证课程笔记 3">
                <i class="fa fa-chevron-left"></i> 形式化验证课程笔记 3
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/03/14/Convolutional-Neural-Networks-笔记-1-Foundations-of-Convolutional-Neural-Networks/" rel="prev" title="Convolutional Neural Networks 笔记 1 Foundations of Convolutional Neural Networks">
                Convolutional Neural Networks 笔记 1 Foundations of Convolutional Neural Networks <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Zhang Yang</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">115</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">20</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/dimlight1998" title="GitHub &rarr; https://github.com/dimlight1998" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:dimlight1998@gmail.com" title="E-Mail &rarr; mailto:dimlight1998@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Dafny-学习笔记"><span class="nav-number">1.</span> <span class="nav-text">Dafny 学习笔记</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Guide"><span class="nav-number">1.1.</span> <span class="nav-text">Guide</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Introduction"><span class="nav-number">1.1.1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Methods"><span class="nav-number">1.1.2.</span> <span class="nav-text">Methods</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pre-and-Postconditions"><span class="nav-number">1.1.3.</span> <span class="nav-text">Pre- and Postconditions</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Simple-Usage"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">Simple Usage</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#With-Conditions"><span class="nav-number">1.1.3.2.</span> <span class="nav-text">With Conditions</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Assertions"><span class="nav-number">1.1.4.</span> <span class="nav-text">Assertions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Functions"><span class="nav-number">1.1.5.</span> <span class="nav-text">Functions</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#What-are-Functions"><span class="nav-number">1.1.5.1.</span> <span class="nav-text">What are Functions</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Function-Method"><span class="nav-number">1.1.5.2.</span> <span class="nav-text">Function Method</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Loop-Invariants"><span class="nav-number">1.1.6.</span> <span class="nav-text">Loop Invariants</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Termination"><span class="nav-number">1.1.7.</span> <span class="nav-text">Termination</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Quantifiers"><span class="nav-number">1.1.8.</span> <span class="nav-text">Quantifiers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Predicates"><span class="nav-number">1.1.9.</span> <span class="nav-text">Predicates</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Framing"><span class="nav-number">1.1.10.</span> <span class="nav-text">Framing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Binary-Search"><span class="nav-number">1.1.11.</span> <span class="nav-text">Binary Search</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Conclusion"><span class="nav-number">1.1.12.</span> <span class="nav-text">Conclusion</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Termination-1"><span class="nav-number">1.2.</span> <span class="nav-text">Termination</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Loop-Forever"><span class="nav-number">1.2.1.</span> <span class="nav-text">Loop Forever</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Multiple-Decreases-Expressions"><span class="nav-number">1.2.2.</span> <span class="nav-text">Multiple Decreases Expressions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mutual-Recursive-Methods"><span class="nav-number">1.2.3.</span> <span class="nav-text">Mutual Recursive Methods</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sets"><span class="nav-number">1.3.</span> <span class="nav-text">Sets</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Sets-Operations"><span class="nav-number">1.3.1.</span> <span class="nav-text">Sets Operations</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sets-Comprehension"><span class="nav-number">1.3.2.</span> <span class="nav-text">Sets Comprehension</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sequences"><span class="nav-number">1.4.</span> <span class="nav-text">Sequences</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Sequences-Operations"><span class="nav-number">1.4.1.</span> <span class="nav-text">Sequences Operations</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sequences-Construction"><span class="nav-number">1.4.2.</span> <span class="nav-text">Sequences Construction</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Collections"><span class="nav-number">1.5.</span> <span class="nav-text">Collections</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Multisets"><span class="nav-number">1.5.1.</span> <span class="nav-text">Multisets</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Maps"><span class="nav-number">1.5.2.</span> <span class="nav-text">Maps</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Maps-Operations"><span class="nav-number">1.5.2.1.</span> <span class="nav-text">Maps Operations</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Maps-Constructions"><span class="nav-number">1.5.2.2.</span> <span class="nav-text">Maps Constructions</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lemmas"><span class="nav-number">1.6.</span> <span class="nav-text">Lemmas</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Modules"><span class="nav-number">1.7.</span> <span class="nav-text">Modules</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">1.8.</span> <span class="nav-text">References</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhang Yang</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.0.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=7.0.1"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('3');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
  

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });
  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') { next = next.nextSibling }
        if (next && next.nodeName.toLowerCase() === 'br') { next.parentNode.removeChild(next) }
      }
    });
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>
<script src="//cdn.jsdelivr.net/npm/mathjax@2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<style>
.MathJax_Display {
  overflow-x: scroll;
  overflow-y: hidden;
}
</style>

    
  


  

  

  

  

  

  

  

  

  

</body>
</html>
